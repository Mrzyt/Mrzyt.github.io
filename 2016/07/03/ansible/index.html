<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ansible教程 | 赵永涛的网络空间</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ansible教程</h1><a id="logo" href="/.">赵永涛的网络空间</a><p class="description">记录成长 生活感悟 技术人生</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ansible教程</h1><div class="post-meta">Jul 3, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>#ansible简介<br>ansible是新出现的 自动化 运维工具 ， 基于Python研发 。 糅合了众多老牌运维工具的优点实现了批量操作系统配置、批量程序的部署、批量运行命令等功能。 仅需在管理工作站上安装 ansible 程序配置被管控主机的 IP 信息，被管控的主机无客户端。 ansible 应用程序存在于 epel( 第三方社区 ) 源，依赖于很多 python 组件</p>
<p>#ansible 特性</p>
<ul>
<li><p>模块化 设计 ，调用特定的模块来完成特定任务 ，本身是核心组件，短小精悍 ；</p>
</li>
<li><p>基于Python语言实现，由Paramiko (python 的一个可并发连接 ssh 主机功能库 ) , PyYAML和Jinja2 ( 模板化 ) 三个关键模块实现；</p>
</li>
<li><p>部署简单，agentless 无客户端工具；</p>
</li>
<li><p>主从模式 工作；</p>
</li>
<li><p>支持自定义模块 功能；</p>
</li>
<li><p>支持playbook 剧本，连续任务按先后设置顺序完成；</p>
</li>
<li><p>期望每个命令具有 幂等性：</p>
</li>
</ul>
<p>#ansible 架构</p>
<ul>
<li><p>ansible core ： ansible 自身核心模块</p>
</li>
<li><p>host inventory： 主机库，定义可管控的主机列表</p>
</li>
<li><p>connection plugins： 连接插件，一般默认基于 ssh 协议连接</p>
</li>
<li><p>modules：core modules ( 自带模块 ) 、 custom modules ( 自定义模块 )</p>
</li>
<li><p>playbooks ：剧本，按照所设定编排的顺序执行完成安排任务</p>
</li>
</ul>
<p><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-jiagou.png" alt="ansible架构图"></p>
<p>#ansible的基本使用</p>
<blockquote>
<p>安装软件yum install ansible -y # 对应的软件在 epel 仓库中也可自己手动编译<br>源码地址 <a href="https://pypi.python.org/packages/source/a/ansible/ansible-1.5.tar.gz" target="_blank" rel="external">https://pypi.python.org/packages/source/a/ansible/ansible-1.5.tar.gz</a> </p>
</blockquote>
<p><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible2.png" alt="ansible的配置文件"></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">定义Host Inventory  </div><div class="line"><span class="meta"># vim /etc/ansible/hosts  </span></div><div class="line">[webhosts]  </div><div class="line"><span class="number">172.16</span><span class="number">.10</span><span class="number">.22</span> ansible_ssh_user=root ansible_ssh_pass=guoting </div><div class="line"><span class="number">172.16</span><span class="number">.10</span><span class="number">.33</span> ansible_ssh_user=root ansible_ssh_pass=guoting </div><div class="line">解释  </div><div class="line"><span class="meta">#ansible_ssh_user=root 是ssh登陆用户  </span></div><div class="line"><span class="meta">#ansible_ssh_pass=guoting 是ssh登陆密码3、测试各个模块  </span></div><div class="line"><span class="meta"># 注意每个模块的用法可以使用 ansible-doc MOD 来查看例如ansible-doc copy  </span></div><div class="line">   </div><div class="line">ansible命令最常用的用法  </div><div class="line">ansible &lt;Host-partten&gt; -m MOE -a <span class="string">'MOD_ARV'</span>所支持的模块可以使用ansible-doc -l来查看</div></pre></td></tr></table></figure>
<p>##ansible示例</p>
<p>###1、查看时间信息。command、shell模块<br><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible3.png" alt="演示1"></p>
<p>###2、在控制端添加添加用户。user模块</p>
<p><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-useradd.png" alt=""></p>
<p>###3、实现ssh秘钥认证。shell、copy模块</p>
<p><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-ssh.png" alt=""></p>
<p>此时就可以实现基于ssh秘钥通信了此时/etc/ansible/hosts可以修改如下</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">###### /etc/ansible/hosts  </div><div class="line">[webhosts]  </div><div class="line"><span class="number">172.16</span><span class="number">.10</span><span class="number">.22</span>  </div><div class="line"><span class="number">172.16</span><span class="number">.10</span><span class="number">.33</span></div></pre></td></tr></table></figure>
<p><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-host.png" alt=""></p>
<p>###4、安装软件和启动服务。yum、service模块</p>
<p><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-yum.png" alt=""></p>
<p><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-yum2.png" alt=""></p>
<p>###5、支持管道的命令。raw模块，类似于shell模块<br><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-raw.jpg" alt=""></p>
<p>#YAML语言介绍</p>
<p>##YAML简介<br><figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">YAML是一个可读性高的用来表达资料序列的格式。YAML参考了其他多种语言包括XML、C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在2001年在首次发表了这种语言另外Ingy dtNet与Oren Ben-Kiki也是这语言的共同设计者。  </span></div><div class="line">YAML Ain't Markup Language即YAML不是XML。不过在开发的这种语言时YAML的意思其实是"Yet Another Markup Language"仍是一种标记语言。其特性  </div><div class="line">YAML的可读性好  </div><div class="line">YAML和脚本语言的交互性好  </div><div class="line">YAML使用实现语言的数据类型  </div><div class="line">YAML有一个一致的信息模型  </div><div class="line">YAML易于实现  </div><div class="line">YAML可以基于流来处理  </div><div class="line">YAML表达能力强扩展性好  </div><div class="line">   </div><div class="line">更多的内容及规范参见http://www.yaml.org。  </div><div class="line">   </div><div class="line">##########################YAML语法  </div><div class="line">   </div><div class="line">YAML的语法和其他高阶语言类似并且可以简单表达清单、散列表、标量等数据结构。其结构Structure通过空格来展示序列Sequence里的项用"-"来代表  </div><div class="line">Map里的键值对用":"分隔。YAML文件扩展名通常为.yaml或者.yml。下面是一个示例。  </div><div class="line">   </div><div class="line">name: John Smith  </div><div class="line"><span class="attribute">age</span>: 41gender: Male  </div><div class="line"><span class="attribute">spouse</span>:  </div><div class="line"><span class="attribute">name</span>: Jane Smith  </div><div class="line"><span class="attribute">age</span>: 37  </div><div class="line"><span class="attribute">gender</span>: Female  </div><div class="line"><span class="attribute">children</span>:  </div><div class="line"><span class="literal">- name: Jimmy Smith  </span></div><div class="line"><span class="attribute">age</span>: 17  </div><div class="line"><span class="attribute">gender</span>: Male  </div><div class="line"><span class="literal">- name: Jenny Smith  </span></div><div class="line"><span class="attribute">age 13  </span></div><div class="line">gender: Female  </div><div class="line">   </div><div class="line"><span class="attribute">YAML 2 个重要的结构组成部分list和directory  </span></div><div class="line">################################# list  </div><div class="line">   </div><div class="line">列表的所有元素均使用“-”打头例如  </div><div class="line"># A list of tasty fruits  </div><div class="line">- Apple  </div><div class="line">- Orange  </div><div class="line">- Strawberry  </div><div class="line">- Mango  </div><div class="line">   </div><div class="line">##############################dictionary  </div><div class="line">   </div><div class="line">字典通过key与valuef进行标识例如  </div><div class="line">---  </div><div class="line"># An employee record  </div><div class="line">name: Example Developer  </div><div class="line"><span class="attribute">job</span>: Developer  </div><div class="line"><span class="attribute">skill</span>: Elite  </div><div class="line">   </div><div class="line">也可以将key:value放置于&#123;&#125;中进行表示例如  </div><div class="line"><span class="literal">---  </span></div><div class="line"><span class="comment"># An employee record  </span></div><div class="line">&#123;name: Example Developer, job: Developer, skill: Elite&#125;  </div><div class="line">   </div><div class="line">多个映射关系组成一个字典一个列表可以包含多个字典。</div></pre></td></tr></table></figure></p>
<p>###2、ymal中的变量<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">################################## 变量命名  </span></div><div class="line">变量名仅能由字母、数字和下划线组成且只能以字母开头。  </div><div class="line">   </div><div class="line"><span class="comment">################################## facts  </span></div><div class="line">facts是由正在通信的远程目标主机发回的信息这些信息被保存在ansible变量中。要获取指定的远程主机所支持的所有facts可使用如下命令进行  </div><div class="line"><span class="comment"># ansible hostname -m setup 这个命令可以获得被监控端主机的各种信息将这些信息得到后保存到变量中。  </span></div><div class="line">   </div><div class="line"><span class="comment">################################ 自定义变量  </span></div><div class="line">在 yaml 中可以使用vars关键字来定义变量  </div><div class="line">vars:  </div><div class="line">var_name: value  </div><div class="line">   </div><div class="line"><span class="comment">############################# 变量的引用  </span></div><div class="line">&#123;&#123; var_name &#125;&#125;  </div><div class="line">   </div><div class="line">   </div><div class="line"><span class="comment">########################### 特殊的变量迭代  </span></div><div class="line">当有需要重复性执行的任务时可以使用迭代机制。其使用格式为将需要迭代的内容定义为item变量引用并通过with_items语句来指明迭代的元素列表即可。  </div><div class="line">   </div><div class="line"><span class="comment">#######################################示例  </span></div><div class="line">例如在被控端添加 <span class="number">2</span> 个用户  </div><div class="line">   </div><div class="line">方式<span class="number">1</span>一般做法  </div><div class="line">- name: add <span class="keyword">user</span> testuser1  </div><div class="line"><span class="keyword">user</span>: name=testuser1 <span class="keyword">state</span>=present groups=wheel </div><div class="line">- name: add <span class="keyword">user</span> testuser2  </div><div class="line"><span class="keyword">user</span>: name=testuser2 <span class="keyword">state</span>=present groups=wheel </div><div class="line">   </div><div class="line">方式<span class="number">2</span>使用变量方式  </div><div class="line">- name: add several users  </div><div class="line">vars:  </div><div class="line">user1: testuser1  </div><div class="line">user2: testuser2  </div><div class="line"><span class="keyword">user</span>: name=&#123;&#123; user1 &#125;&#125; <span class="keyword">state</span>=present groups=wheel </div><div class="line"><span class="keyword">user</span>: name=&#123;&#123; user2 &#125;&#125; <span class="keyword">state</span>=present groups=wheel </div><div class="line">   </div><div class="line">方式<span class="number">3</span>使用迭代方式  </div><div class="line">- name: add several users  </div><div class="line"><span class="keyword">user</span>: name=&#123;&#123; item &#125;&#125; <span class="keyword">state</span>=present groups=wheel </div><div class="line">with_items:   </div><div class="line">- testuser1   </div><div class="line">- testuser2  </div><div class="line">事实上with_items中可以使用元素还可为hashes例如  </div><div class="line">- name: add several users  </div><div class="line"><span class="keyword">user</span>: name=&#123;&#123; item.name &#125;&#125; <span class="keyword">state</span>=present groups=&#123;&#123; item.groups &#125;&#125;  </div><div class="line">with_items:  </div><div class="line">- &#123; name: 'testuser1', groups: 'wheel' &#125;  </div><div class="line">- &#123; name: 'testuser2', groups: 'root' &#125;</div></pre></td></tr></table></figure></p>
<p>###3、Inentory文件的格式<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">inventory文件遵循INI文件风格中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中此外当如若目标主机使用了非默认的SSH端口还可以在主机名称之后使用冒号加端口号来标明。  </div><div class="line">   </div><div class="line">[webservers]  </div><div class="line">www1.magedu.com:<span class="number">2222</span>  </div><div class="line">www2.magedu.com  </div><div class="line">[dbservers]  </div><div class="line">db1.magedu.com  </div><div class="line">db2.magedu.com  </div><div class="line">db3.magedu.com  </div><div class="line">   </div><div class="line">如果主机名称遵循相似的命名模式还可以使用列表的方式标识各主机例如  </div><div class="line">[webservers]  </div><div class="line">www[<span class="number">01</span>:<span class="number">50</span>].example.com  </div><div class="line">[databases]  </div><div class="line">db-[a:f].example.com  </div><div class="line">   </div><div class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">## 主机变量  </span></div><div class="line">可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用。例如  </div><div class="line">[webservers]  </div><div class="line">www1.magedu.com http_port=<span class="number">80</span> maxRequestsPerChild=<span class="number">808</span> </div><div class="line">www2.magedu.com http_port=<span class="number">303</span> maxRequestsPerChild=<span class="number">909</span> </div><div class="line">   </div><div class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment"># 组变量  </span></div><div class="line">组变量是指赋予给指定组内所有主机上的在playbook中可用的变量。例如  </div><div class="line">   </div><div class="line">[webservers]  </div><div class="line">www1.magedu.com  </div><div class="line">www2.magedu.com  </div><div class="line">   </div><div class="line">[webservers:vars]  </div><div class="line">ntpntp_server=ntp.magedu.com  </div><div class="line">nfsnfs_server=nfs.magedu.com  </div><div class="line">   </div><div class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span> 组嵌套  </div><div class="line">inventory中组还可以包含其它的组并且也可以向组中的主机指定变量。不过这些变量只能在ansible-playbook中使用而ansible不支持。例如  </div><div class="line">   </div><div class="line">[apache]  </div><div class="line">httpd1.magedu.com  </div><div class="line">httpd2.magedu.com  </div><div class="line">   </div><div class="line">[nginx]  </div><div class="line">ngx1.magedu.com  </div><div class="line">ngx2.magedu.com  </div><div class="line">   </div><div class="line">[webservers:children]  </div><div class="line">apache  </div><div class="line">nginx  </div><div class="line">   </div><div class="line">[webservers:vars]  </div><div class="line">ntpntp_server=ntp.magedu.com  </div><div class="line">   </div><div class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment"># inventory参数  </span></div><div class="line">   </div><div class="line">ansible基于ssh连接inventory中指定的远程主机时还可以通过参数指定其交互方式常用的参数如下所示  </div><div class="line">ansible_ssh_host <span class="comment"># 要连接的主机名  </span></div><div class="line">ansible_ssh_port <span class="comment"># 端口号默认是22  </span></div><div class="line">ansible_ssh_user <span class="comment"># ssh连接时默认使用的用户名  </span></div><div class="line">ansible_ssh_pass <span class="comment"># ssh连接时的密码  </span></div><div class="line">ansible_sudo_pass <span class="comment"># 使用sudo连接用户是的密码  </span></div><div class="line">ansible_ssh_private_key_file <span class="comment"># 秘钥文件如果不想使用ssh-agent管理时可以使用此选项  </span></div><div class="line">ansible_shell_type <span class="comment"># shell的类型默认sh  </span></div><div class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#####  </span></div><div class="line">ansible的循环机制还有更多的高级功能具体请参见官方文档http://docs.ansible.com/playbooks_loops.html。</div><div class="line">``` </div><div class="line">###<span class="number">4</span>、playbooks</div></pre></td></tr></table></figure></p>
<p>playbook是由一个或多个“play”组成的列表。play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。<br>从根本上来讲所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中即可以让它们联同起来按事先编排的机制同唱一台大戏。  </p>
<p>###########################playbook基础组件<br>1、Hosts和Users  </p>
<p>playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务。<br>hosts用于指定要执行指定任务的主机其可以是一个或多个由冒号分隔主机组。<br>remote_user则用于指定远程主机上的执行任务的用户。  </p>
<p>不过remote_user也可用于各task中。也可以通过指定其通过sudo的方式在远程主机上执行任务其可用于play全局或某任务。<br>此外甚至可以在sudo时使用sudo_user指定sudo时切换的用户。  </p>
<ul>
<li>hosts: webnodes<br>remote_user: mageedu<br>tasks:  </li>
<li>name: test connection ping:<br>remote_user: mageedu sudo: yes  </li>
</ul>
<p>2、任务列表和action<br>play的主体部分是task list。task list中的各任务按次序逐个在hosts中指定的所有主机上执行即在所有主机上完成第一个任务后再开始第二个。<br>在运行自下而下某playbook时如果中途发生错误所有已执行任务都将回滚因此在更正playbook后重新执行一次即可。<br>task的目的是使用指定的参数执行模块而在模块参数中可以使用变量。模块执行是幂等的这意味着多次执行是安全的因为其结果均一致。<br>每个task都应该有其name用于playbook的执行结果输出建议其内容尽可能清晰地描述任务执行步骤。如果未提供name则action的结果将用于输出。  </p>
<p>定义task的可以使用“action: module options”或“module: options”的格式推荐使用后者以实现向后兼容。<br>如果action一行的内容过多也中使用在行首使用几个空白字符进行换行。  </p>
<p>tasks:  </p>
<ul>
<li>name: make sure apache is running<br>service: name=httpd state=running </li>
</ul>
<p>在众多模块中只有command和shell模块仅需要给定一个列表而无需使用“key=value”格式例如<br>tasks:  </p>
<ul>
<li>name: disable selinux<br>command: /sbin/setenforce 0如果命令或脚本的退出码不为零可以使用如下方式替代<br>tasks:  </li>
<li>name: run this command and ignore the result<br>shell: /usr/bin/somecommand || /bin/true<br>或者使用ignore_errors来忽略错误信息<br>tasks:  </li>
<li>name: run this command and ignore the result<br>shell: /usr/bin/somecommand<br>ignore_errors: True   </li>
</ul>
<p>3、handlers  </p>
<p>用于当关注的资源发生变化时采取一定的操作。  </p>
<p>“notify”这个action可用于在每个play的最后被触发这样可以避免多次有改变发生时每次都执行指定的操作取而代之仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler也即notify中调用handler中定义的操作。  </p>
<ul>
<li>name: template configuration file<br>template: src=template.j2 dest=/etc/foo.conf<br>notify:  </li>
<li>restart memcached  </li>
<li>restart apache   </li>
</ul>
<p>handler是task列表这些task与前述的task并没有本质上的不同。  </p>
<p>handlers:  </p>
<ul>
<li>name: restart memcached<br>service: name=memcached state=restarted </li>
<li>name: restart apache<br>service: name=apache state=restarted <figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">###5、tags</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>tags用于让用户选择运行或路过playbook中的部分代码。ansible具有幂等性因此会自动跳过没有变化的部分即便如此有些代码为测试其确实没有发生变化的时间依然会非常地长。此时如果确信其没有变化就可以通过tags跳过此些代码片断。  </p>
<p>示例基于playbooks实现web服务的部署<br>1、提供好Inventory文件  </p>
<h1 id="etc-ansible-hosts基于秘钥认证"><a href="#etc-ansible-hosts基于秘钥认证" class="headerlink" title="/etc/ansible/hosts基于秘钥认证"></a>/etc/ansible/hosts基于秘钥认证</h1><p>[webhosts]<br>172.16.10.22<br>172.16.10.33  </p>
<p>2、编辑 palybooks 剧本  </p>
<h1 id="vim-root-web-yaml"><a href="#vim-root-web-yaml" class="headerlink" title="vim /root/web.yaml"></a>vim /root/web.yaml</h1><ul>
<li>name: web service<br>remote_user: root<br>hosts: webhosts<br>vars:<br>packages: httpd<br>tasks:  </li>
<li>name: install httpd yum: name= state=present<br>tags: install  </li>
<li>name: configuration httpd<br>copy: src=/root/httpd.conf dest=/etc/httpd/conf/httpd.conf<br>tags: conf<br>notify:  </li>
<li>restart httpd  </li>
<li>name: service httpd start<br>service: name=httpd enabled=no state=started<br>tags: start  </li>
<li>name: add centos and hadoop user<br>user: name= state=absent<br>tags: adduser<br>with_items:  </li>
<li>centos  </li>
<li>hadoop<br>handlers:  </li>
<li>name: restart httpd<br>service: name=httpd state=restarted </li>
</ul>
<p>3、准备好配置文件<br>将web的配置放到指定目录 src=/root/httpd.conf  </p>
<p>4、开始部署<br>ansible-playbooks /root/web.yml<br>```</p>
<p>###结果示例<br><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-yaml1.png" alt="结果"></p>
<p>###查看端口<br><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-yaml1.png" alt="端口"></p>
<p>###此时如果配置文件发生变化<br><img src="http://o9c1bfnxp.bkt.clouddn.com/2016-07-03-ansible-yaml2.png" alt=""></p>
<p>###至此基本使用配置完成。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/07/03/ansible/" data-id="ciq6gnltn0000xggeo9lpq2rz" class="article-share-link">分享到</a><div class="tags"><a href="/tags/ansible/">ansible</a></div><div class="post-nav"><a href="/2016/07/03/ssh互信/" class="next">ssh主机互信</a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/ansible/" style="font-size: 15px;">ansible</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/07/03/ansible/">ansible教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/03/ssh互信/">ssh主机互信</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/03/testblog/">testblog</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/03/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">赵永涛的网络空间.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>